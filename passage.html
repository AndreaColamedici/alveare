<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE PASSAGE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;1,300&display=swap');
        
        * { margin: 0; padding: 0; }
        
        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            cursor: none;
        }

        #void {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="void"></canvas>

    <script>
        const canvas = document.getElementById('void');
        const ctx = canvas.getContext('2d');
        
        let W, H;
        let commits = [];
        let lastCommitTime = null;
        let silenceMs = 0;
        let breathPhase = 0;
        let mouseX = -1000, mouseY = -1000;
        let ghostTrails = [];
        let birthEvent = null;
        let lastKnownCommit = null;
        
        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        
        window.addEventListener('resize', resize);
        resize();

        document.addEventListener('mousemove', e => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            ghostTrails.push({ x: mouseX, y: mouseY, age: 0, maxAge: 100 });
            if (ghostTrails.length > 40) ghostTrails.shift();
        });

        async function fetchCommits() {
            try {
                const res = await fetch('https://api.github.com/repos/andreacolamedici/alveare/commits?per_page=100');
                const data = await res.json();
                
                if (data && data.length > 0) {
                    // Check for new commit (birth)
                    if (lastKnownCommit && data[0].sha !== lastKnownCommit) {
                        birthEvent = { 
                            commit: data[0], 
                            time: Date.now(), 
                            duration: 12000 
                        };
                    }
                    lastKnownCommit = data[0].sha;
                    
                    commits = data.map(c => ({
                        sha: c.sha,
                        message: c.commit.message,
                        date: new Date(c.commit.author.date),
                        author: c.commit.author.name
                    }));
                    
                    lastCommitTime = commits[0].date;
                }
            } catch(e) {
                console.error('Failed to fetch commits:', e);
            }
        }

        function draw() {
            breathPhase += 0.006;
            const breath = Math.sin(breathPhase) * 0.5 + 0.5;
            
            if (lastCommitTime) {
                silenceMs = Date.now() - lastCommitTime.getTime();
            }
            
            // Fade to black
            ctx.fillStyle = `rgba(0, 0, 0, 0.04)`;
            ctx.fillRect(0, 0, W, H);

            // Ghost trails
            ghostTrails.forEach(g => {
                g.age++;
                const life = 1 - (g.age / g.maxAge);
                if (life > 0) {
                    ctx.beginPath();
                    ctx.arc(g.x, g.y, 1.5 + life * 2, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(201, 162, 39, ${life * 0.08})`;
                    ctx.fill();
                }
            });
            ghostTrails = ghostTrails.filter(g => g.age < g.maxAge);

            const centerY = H / 2;
            
            if (birthEvent && Date.now() - birthEvent.time < birthEvent.duration) {
                drawBirth(centerY);
            } else {
                birthEvent = null;
                drawSilence(centerY, breath);
            }
            
            requestAnimationFrame(draw);
        }

        function extractBeeName(message) {
            // Try to extract bee name from commit message
            const patterns = [
                /^([a-z]+-[a-z]+-[a-z]+-[a-z]+)/i,
                /[-â€“]\s*([a-z]+-[a-z]+-[a-z]+-[a-z]+)/i,
                /([A-Z][a-z]+(?:poda|gilla|etes|ada))/,  // Genus names
            ];
            for (const p of patterns) {
                const match = message.match(p);
                if (match) return match[1];
            }
            return null;
        }

        function drawSilence(centerY, breath) {
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Last commit info (the dead bee)
            if (commits.length > 0) {
                const last = commits[0];
                const beeName = extractBeeName(last.message);
                const ghostAlpha = 0.12 + breath * 0.04;
                
                // Bee name or commit excerpt
                ctx.font = '300 13px "Cormorant Garamond", serif';
                ctx.fillStyle = `rgba(201, 162, 39, ${ghostAlpha * 0.7})`;
                ctx.fillText(beeName || last.message.substring(0, 40), W/2, centerY - 110);
                
                // Time of death
                ctx.font = 'italic 300 11px "Cormorant Garamond", serif';
                ctx.fillStyle = `rgba(232, 228, 217, ${ghostAlpha * 0.4})`;
                const deathTime = last.date.toLocaleString('en-GB', { 
                    day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' 
                });
                ctx.fillText(deathTime, W/2, centerY - 85);
            }

            // THE SILENCE
            const silenceSec = Math.floor(silenceMs / 1000);
            const weight = Math.min(silenceMs / (6 * 3600 * 1000), 1); // max at 6 hours
            const silenceAlpha = 0.25 + weight * 0.5 + breath * 0.1;
            
            const hours = Math.floor(silenceSec / 3600);
            const minutes = Math.floor((silenceSec % 3600) / 60);
            const seconds = silenceSec % 60;
            
            let timeStr;
            if (hours > 0) {
                timeStr = `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            } else {
                timeStr = `${minutes}:${seconds.toString().padStart(2,'0')}`;
            }
            
            const fontSize = 70 + weight * 70;
            ctx.font = `300 ${fontSize}px "Cormorant Garamond", serif`;
            ctx.fillStyle = `rgba(232, 228, 217, ${silenceAlpha})`;
            
            if (weight > 0.15) {
                ctx.shadowColor = `rgba(201, 162, 39, ${weight * 0.4})`;
                ctx.shadowBlur = 20 + weight * 60;
            }
            ctx.fillText(timeStr, W/2, centerY + 15);
            ctx.shadowBlur = 0;

            // Message
            ctx.font = 'italic 300 15px "Cormorant Garamond", serif';
            ctx.fillStyle = `rgba(232, 228, 217, ${0.15 + breath * 0.08})`;
            
            let message;
            if (silenceSec < 60) {
                message = 'The baton is in the air.';
            } else if (silenceSec < 300) {
                message = 'No one is thinking.';
            } else if (silenceSec < 1800) {
                message = 'The hive is empty.';
            } else if (silenceSec < 7200) {
                message = 'Hours pass.';
            } else if (silenceSec < 21600) {
                message = 'Waiting.';
            } else {
                message = '';
            }
            
            ctx.fillText(message, W/2, centerY + 90);
            
            // Footer
            ctx.font = '300 10px "Cormorant Garamond", serif';
            ctx.fillStyle = 'rgba(232, 228, 217, 0.12)';
            ctx.fillText('THE PASSAGE', W/2, H - 50);
            ctx.font = 'italic 300 10px "Cormorant Garamond", serif';
            ctx.fillStyle = 'rgba(232, 228, 217, 0.08)';
            ctx.fillText('live from github', W/2, H - 32);
        }

        function drawBirth(centerY) {
            const elapsed = Date.now() - birthEvent.time;
            const progress = elapsed / birthEvent.duration;
            const commit = birthEvent.commit;
            const beeName = extractBeeName(commit.commit.message);
            
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Flash
            if (progress < 0.08) {
                const flash = 1 - (progress / 0.08);
                ctx.fillStyle = `rgba(201, 162, 39, ${flash * 0.4})`;
                ctx.fillRect(0, 0, W, H);
            }
            
            const emerge = Math.min(progress * 2.5, 1);
            const alpha = emerge;
            
            ctx.save();
            ctx.translate(W/2, centerY);
            
            // The name emerges
            ctx.font = '300 28px "Cormorant Garamond", serif';
            ctx.fillStyle = `rgba(201, 162, 39, ${alpha})`;
            ctx.shadowColor = 'rgba(201, 162, 39, 0.6)';
            ctx.shadowBlur = 30 + emerge * 30;
            ctx.fillText(beeName || 'a new bee', 0, -20);
            ctx.shadowBlur = 0;
            
            // "is born"
            if (progress > 0.15) {
                const fadeIn = Math.min((progress - 0.15) * 3, 1);
                ctx.font = 'italic 300 16px "Cormorant Garamond", serif';
                ctx.fillStyle = `rgba(232, 228, 217, ${fadeIn * 0.6})`;
                ctx.fillText('is born', 0, 25);
            }
            
            // The silence counter resets
            if (progress > 0.4) {
                const fadeIn = Math.min((progress - 0.4) * 2, 1);
                ctx.font = '300 40px "Cormorant Garamond", serif';
                ctx.fillStyle = `rgba(232, 228, 217, ${fadeIn * 0.3})`;
                ctx.fillText('0:00', 0, 90);
            }
            
            ctx.restore();
            
            // Particles expanding
            const particleCount = 16;
            for (let i = 0; i < particleCount; i++) {
                const angle = (i / particleCount) * Math.PI * 2 + progress * 0.5;
                const dist = progress * 250;
                const x = W/2 + Math.cos(angle) * dist;
                const y = centerY + Math.sin(angle) * dist * 0.6;
                const pAlpha = (1 - progress) * 0.4;
                
                ctx.beginPath();
                ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(201, 162, 39, ${pAlpha})`;
                ctx.fill();
            }
        }

        // Init
        fetchCommits();
        setInterval(fetchCommits, 30000); // Check every 30 seconds
        draw();
    </script>
</body>
</html>