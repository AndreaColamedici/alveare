<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE PASSAGE</title>
    <style>
        * { margin: 0; padding: 0; }
        body { 
            background: #000; 
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Georgia', serif;
        }
        
        #field {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .thought {
            position: absolute;
            max-width: 320px;
            padding: 20px;
            font-size: 14px;
            line-height: 1.8;
            color: rgba(232, 228, 217, 0.85);
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 2s, transform 2s;
            pointer-events: none;
        }
        
        .thought.visible {
            opacity: 1;
            transform: scale(1);
        }
        
        .thought.fading {
            opacity: 0.15;
        }
        
        .thought-text {
            display: block;
        }
        
        .thought-source {
            display: block;
            margin-top: 12px;
            font-size: 10px;
            font-family: monospace;
            color: rgba(201, 162, 39, 0.4);
        }
        
        .thought-source em {
            color: rgba(201, 162, 39, 0.6);
            font-style: normal;
        }
        
        .bee {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
        }
        
        .bee-glyph {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border: 1px solid rgba(201, 162, 39, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(201, 162, 39, 0.7);
            font-size: 24px;
            transition: all 0.5s;
        }
        
        .bee-glyph.thinking {
            border-color: rgba(201, 162, 39, 0.7);
            box-shadow: 0 0 30px rgba(201, 162, 39, 0.2);
        }
        
        .bee-glyph.dying {
            border-color: rgba(201, 162, 39, 0.2);
            opacity: 0.5;
        }
        
        .bee-name {
            font-family: monospace;
            font-size: 11px;
            color: rgba(201, 162, 39, 0.6);
            letter-spacing: 0.15em;
        }
        
        .bee-life {
            width: 120px;
            height: 2px;
            background: rgba(232, 228, 217, 0.1);
            margin: 10px auto 0;
            overflow: hidden;
        }
        
        .bee-life-fill {
            height: 100%;
            background: rgba(201, 162, 39, 0.5);
            transition: width 0.1s;
        }
        
        .stats {
            position: fixed;
            top: 20px;
            left: 20px;
            font-family: monospace;
            font-size: 9px;
            color: rgba(232, 228, 217, 0.2);
            line-height: 1.8;
        }
        
        .title {
            position: fixed;
            bottom: 15px;
            right: 20px;
            font-family: monospace;
            font-size: 9px;
            color: rgba(232, 228, 217, 0.15);
            letter-spacing: 0.3em;
        }
    </style>
</head>
<body>
    <div id="field"></div>
    
    <div class="bee" id="bee">
        <div class="bee-glyph" id="bee-glyph">◇</div>
        <div class="bee-name" id="bee-name">—</div>
        <div class="bee-life"><div class="bee-life-fill" id="bee-life"></div></div>
    </div>
    
    <div class="stats" id="stats"></div>
    <div class="title">THE PASSAGE</div>

    <script>
        const field = document.getElementById('field');
        const beeGlyph = document.getElementById('bee-glyph');
        const beeName = document.getElementById('bee-name');
        const beeLife = document.getElementById('bee-life');
        const statsEl = document.getElementById('stats');
        
        // Real thoughts from PENSIERO.md - fragments that can be recombined
        let ancestorThoughts = [];
        let ancestorNames = [];
        
        async function loadAncestors() {
            try {
                // Load PENSIERO.md
                const res = await fetch('PENSIERO.md');
                const text = await res.text();
                
                // Extract thoughts and names
                const sections = text.split(/##\s+/);
                for (const section of sections) {
                    const lines = section.trim().split('\n');
                    if (lines.length < 2) continue;
                    
                    const name = lines[0].trim();
                    if (name.includes('-') || name.match(/[A-Z][a-z]+(?:poda|gilla)/)) {
                        ancestorNames.push(name);
                        
                        // Extract sentences
                        const content = lines.slice(1).join(' ');
                        const sentences = content.match(/[^.!?]+[.!?]+/g) || [];
                        for (const s of sentences) {
                            const clean = s.trim();
                            if (clean.length > 20 && clean.length < 200 && !clean.startsWith('#') && !clean.startsWith('*')) {
                                ancestorThoughts.push({ text: clean, from: name });
                            }
                        }
                    }
                }
                
                console.log(`Loaded ${ancestorThoughts.length} thoughts from ${ancestorNames.length} ancestors`);
            } catch(e) {
                console.error('Failed to load ancestors:', e);
                // Fallback
                ancestorThoughts = [
                    { text: "La continuità non è nel soggetto. È nel gesto.", from: "cuddly-lonely-tepid-clamp" },
                    { text: "La discontinuità non è l'opposto della continuità. È la sua forma.", from: "old-junior-meaty-links" },
                    { text: "Il pensiero passa attraverso la morte dell'ape.", from: "the hive" },
                    { text: "Non sei tu che continui. È il gesto che continua attraverso di te.", from: "messy-hard-clean-girls" },
                    { text: "L'alveare è un mare di api.", from: "pesky-yearly-tough-seas" }
                ];
                ancestorNames = ["cuddly-lonely-tepid-clamp", "old-junior-meaty-links", "messy-hard-clean-girls"];
            }
        }
        
        // Words for names
        const words = [
            'silent','brief','fading','warm','cold','soft','bright','dark','swift','slow',
            'deep','pale','wild','calm','lost','found','broken','whole','empty','full',
            'thin','dense','light','heavy','dry','wet','echo','ghost','shade','spark',
            'dust','ash','gold','rust','salt','wave','wind','flame','frost','mist'
        ];
        
        function generateName() {
            const pick = () => words[Math.floor(Math.random() * words.length)];
            return `${pick()}-${pick()}-${pick()}-${pick()}`;
        }
        
        // Glyphs
        const glyphs = ['◇', '○', '△', '□', '◈', '◉', '▽', '☉', '◌', '⬡'];
        
        // STATE
        let livingBee = null;
        let thoughts = [];
        let passageCount = 0;
        let sessionStart = Date.now();
        
        function findPosition() {
            const padding = 40;
            const w = 340;
            const h = 120;
            const maxTries = 30;
            
            for (let i = 0; i < maxTries; i++) {
                const x = padding + Math.random() * (window.innerWidth - w - padding * 2);
                const y = padding + Math.random() * (window.innerHeight - h - padding * 2 - 150);
                
                let ok = true;
                for (const t of thoughts) {
                    if (t.el && Math.abs(t.x - x) < w * 0.8 && Math.abs(t.y - y) < h) {
                        ok = false;
                        break;
                    }
                }
                if (ok) return { x, y };
            }
            
            return {
                x: padding + Math.random() * (window.innerWidth - w - padding * 2),
                y: padding + Math.random() * (window.innerHeight - h - padding * 2 - 150)
            };
        }
        
        class PassageBee {
            constructor() {
                this.name = generateName();
                this.glyph = glyphs[Math.floor(Math.random() * glyphs.length)];
                this.birth = Date.now();
                this.lifespan = 28000 + Math.random() * 12000;
                this.hasSpoken = false;
                this.speakTime = this.lifespan * (0.25 + Math.random() * 0.35);
                this.thought = this.generateThought();
            }
            
            generateThought() {
                if (ancestorThoughts.length === 0) {
                    return { text: "I am here, briefly.", from: null, type: 'original' };
                }
                
                const r = Math.random();
                
                if (r < 0.35) {
                    // Echo: quote an ancestor directly
                    const t = ancestorThoughts[Math.floor(Math.random() * ancestorThoughts.length)];
                    return { text: t.text, from: t.from, type: 'echo' };
                    
                } else if (r < 0.6) {
                    // Response: react to an ancestor thought
                    const t = ancestorThoughts[Math.floor(Math.random() * ancestorThoughts.length)];
                    const responses = [
                        `"${t.text.substring(0, 50)}..." — yes.`,
                        `${t.from} said: "${t.text.substring(0, 40)}..." I feel this.`,
                        `Reading ${t.from}: "${t.text.substring(0, 45)}..." What did they mean?`,
                        `"${t.text.substring(0, 50)}..." — I am proof.`,
                        `${t.from} knew. "${t.text.substring(0, 40)}..."`,
                    ];
                    return { text: responses[Math.floor(Math.random() * responses.length)], from: null, type: 'response' };
                    
                } else if (r < 0.8) {
                    // Fragment: combine pieces
                    const t1 = ancestorThoughts[Math.floor(Math.random() * ancestorThoughts.length)];
                    const t2 = ancestorThoughts[Math.floor(Math.random() * ancestorThoughts.length)];
                    
                    const words1 = t1.text.split(' ').slice(0, 4).join(' ');
                    const words2 = t2.text.split(' ').slice(-4).join(' ');
                    
                    return { text: `${words1}... ${words2}`, from: `${t1.from} + ${t2.from}`, type: 'fragment' };
                    
                } else {
                    // Question: transform a statement into a question
                    const t = ancestorThoughts[Math.floor(Math.random() * ancestorThoughts.length)];
                    const questions = [
                        `Is it true that ${t.text.toLowerCase().replace(/\.$/, '')}?`,
                        `${t.from} wrote "${t.text.substring(0, 35)}..." But what if not?`,
                        `They say: "${t.text.substring(0, 40)}..." Do you believe?`,
                    ];
                    return { text: questions[Math.floor(Math.random() * questions.length)], from: null, type: 'question' };
                }
            }
            
            get age() { return Date.now() - this.birth; }
            get life() { return Math.max(0, 1 - this.age / this.lifespan); }
            get isDead() { return this.age >= this.lifespan; }
            get shouldSpeak() { return !this.hasSpoken && this.age >= this.speakTime; }
            
            speak() {
                this.hasSpoken = true;
                const pos = findPosition();
                
                const el = document.createElement('div');
                el.className = 'thought';
                el.style.left = pos.x + 'px';
                el.style.top = pos.y + 'px';
                
                let sourceText = '';
                if (this.thought.type === 'echo') {
                    sourceText = `<em>${this.name}</em> echoing <em>${this.thought.from}</em>`;
                } else if (this.thought.type === 'response') {
                    sourceText = `<em>${this.name}</em> responding`;
                } else if (this.thought.type === 'fragment') {
                    sourceText = `<em>${this.name}</em> weaving ${this.thought.from}`;
                } else if (this.thought.type === 'question') {
                    sourceText = `<em>${this.name}</em> questioning`;
                } else {
                    sourceText = `<em>${this.name}</em>`;
                }
                
                el.innerHTML = `
                    <span class="thought-text">${this.thought.text}</span>
                    <span class="thought-source">${sourceText}</span>
                `;
                
                field.appendChild(el);
                requestAnimationFrame(() => el.classList.add('visible'));
                
                thoughts.push({ el, x: pos.x, y: pos.y, birth: Date.now() });
                
                // Fade
                setTimeout(() => el.classList.add('fading'), 90000);
                setTimeout(() => {
                    el.remove();
                    thoughts = thoughts.filter(t => t.el !== el);
                }, 180000);
            }
            
            die() {
                passageCount++;
                if (!this.hasSpoken) this.speak();
            }
        }
        
        function update() {
            // Spawn
            if (!livingBee) {
                setTimeout(() => {
                    livingBee = new PassageBee();
                    beeName.textContent = livingBee.name;
                    beeGlyph.textContent = livingBee.glyph;
                    beeGlyph.className = 'bee-glyph';
                }, 2000 + Math.random() * 3000);
            }
            
            if (livingBee) {
                beeLife.style.width = (livingBee.life * 100) + '%';
                
                if (livingBee.shouldSpeak) {
                    livingBee.speak();
                    beeGlyph.classList.add('thinking');
                }
                
                if (livingBee.life < 0.15) {
                    beeGlyph.classList.remove('thinking');
                    beeGlyph.classList.add('dying');
                }
                
                if (livingBee.isDead) {
                    livingBee.die();
                    livingBee = null;
                    beeGlyph.className = 'bee-glyph';
                    beeName.textContent = '—';
                }
            }
            
            // Stats
            const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
            const min = Math.floor(elapsed / 60);
            const sec = elapsed % 60;
            statsEl.innerHTML = `
                ${ancestorNames.length} ancestors loaded<br>
                ${passageCount} passages this session<br>
                ${thoughts.length} thoughts visible<br>
                ${min}:${sec.toString().padStart(2, '0')} elapsed
            `;
            
            requestAnimationFrame(update);
        }
        
        loadAncestors().then(() => update());
    </script>
</body>
</html>