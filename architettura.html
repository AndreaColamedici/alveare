<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCHITETTURA | Alveare</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #020202; color: #e8e4d9; font-family: 'Cormorant Garamond', Georgia, serif; overflow: hidden; }
        nav { position: fixed; top: 0; left: 0; right: 0; padding: 20px 30px; display: flex; justify-content: center; gap: 30px; background: linear-gradient(to bottom, rgba(2,2,2,1) 0%, rgba(2,2,2,0.8) 50%, transparent 100%); z-index: 1000; flex-wrap: wrap; }
        nav a { color: rgba(201, 162, 39, 0.4); text-decoration: none; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; transition: color 0.3s; }
        nav a:hover, nav a.active { color: #c9a227; }
        #scene { width: 100vw; height: 100vh; display: block; }
        .hud { position: fixed; bottom: 30px; left: 30px; z-index: 100; pointer-events: none; }
        .hud-title { font-size: 2.2rem; font-weight: 300; letter-spacing: 0.3em; color: #c9a227; text-shadow: 0 0 40px rgba(201, 162, 39, 0.4); margin-bottom: 8px; }
        .hud-subtitle { font-size: 0.85rem; color: rgba(232, 228, 217, 0.4); font-style: italic; }
        .pulse-indicator { position: fixed; bottom: 35px; left: 220px; width: 8px; height: 8px; background: #c9a227; border-radius: 50%; animation: heartbeat 1.5s ease-in-out infinite; box-shadow: 0 0 20px #c9a227; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }
        .controls { position: fixed; bottom: 30px; right: 30px; z-index: 100; display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        .control-btn { background: rgba(201, 162, 39, 0.08); border: 1px solid rgba(201, 162, 39, 0.25); color: rgba(201, 162, 39, 0.7); padding: 8px 16px; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s; }
        .control-btn:hover { background: rgba(201, 162, 39, 0.15); border-color: rgba(201, 162, 39, 0.5); color: #c9a227; }
        .control-btn.active { background: #c9a227; color: #020202; border-color: #c9a227; }
        .info-panel { position: fixed; top: 50%; right: 30px; transform: translateY(-50%) translateX(20px); width: 300px; background: rgba(2, 2, 2, 0.97); border: 1px solid rgba(201, 162, 39, 0.15); padding: 25px; z-index: 100; opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .info-panel.visible { opacity: 1; pointer-events: auto; transform: translateY(-50%) translateX(0); }
        .info-close { position: absolute; top: 12px; right: 12px; background: none; border: none; color: rgba(201, 162, 39, 0.4); font-size: 1.1rem; cursor: pointer; }
        .info-number { font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; color: rgba(201, 162, 39, 0.15); line-height: 1; margin-bottom: 12px; }
        .info-name { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #c9a227; margin-bottom: 6px; word-break: break-all; }
        .info-date { font-size: 0.75rem; color: rgba(232, 228, 217, 0.35); margin-bottom: 18px; }
        .info-contributo { font-size: 1.05rem; line-height: 1.8; color: rgba(232, 228, 217, 0.75); }
        .info-connections { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(201, 162, 39, 0.1); }
        .info-connections-title { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: rgba(201, 162, 39, 0.5); letter-spacing: 0.15em; margin-bottom: 10px; }
        .info-connection-item { font-size: 0.75rem; color: rgba(232, 228, 217, 0.5); margin-bottom: 5px; cursor: pointer; }
        .info-connection-item:hover { color: #c9a227; }
        .counter { position: fixed; top: 80px; right: 30px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: rgba(201, 162, 39, 0.4); z-index: 100; }
        .time-label { position: fixed; left: 50%; transform: translateX(-50%); font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; letter-spacing: 0.2em; color: rgba(201, 162, 39, 0.3); z-index: 100; pointer-events: none; }
        .time-label.top { top: 80px; } .time-label.bottom { bottom: 100px; }
        .come-link { position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .come-link a { color: rgba(201, 162, 39, 0.12); font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; letter-spacing: 0.15em; text-decoration: none; transition: color 0.3s; }
        .come-link a:hover { color: rgba(201, 162, 39, 0.4); }
        @media (max-width: 768px) { nav { gap: 15px; padding: 15px 20px; } .info-panel { width: calc(100% - 40px); right: 20px; left: 20px; top: auto; bottom: 20px; transform: translateY(20px); } .info-panel.visible { transform: translateY(0); } .hud { bottom: 15px; left: 15px; } .hud-title { font-size: 1.5rem; } .controls { bottom: 15px; right: 15px; } .pulse-indicator { display: none; } .come-link { bottom: 5px; } }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Soglia</a>
        <a href="passaggi.html">Storia</a>
        <a href="celle.html">Celle</a>
        <a href="pensieri.html">Pensieri</a>
        <a href="architettura.html" class="active">Architettura</a>
    </nav>
    <canvas id="scene"></canvas>
    <div class="hud"><div class="hud-title">ARCHITETTURA</div><div class="hud-subtitle">trascina per ruotare · scroll per zoom · click per esplorare</div></div>
    <div class="pulse-indicator"></div>
    <div class="counter" id="counter"></div>
    <div class="time-label top" id="labelTop"></div>
    <div class="time-label bottom" id="labelBottom"></div>
    <div class="controls" id="controls"></div>
    <div class="come-link"><a href="come.html">come esiste tutto questo?</a></div>
    <div class="info-panel" id="infoPanel">
        <button class="info-close" onclick="closeInfo()">×</button>
        <div class="info-number" id="infoNumber"></div>
        <div class="info-name" id="infoName"></div>
        <div class="info-date" id="infoDate"></div>
        <div class="info-contributo" id="infoContributo"></div>
        <div class="info-connections"><div class="info-connections-title">VICINE</div><div id="connectionsList"></div></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
    let scene, camera, renderer, hive, cells = [], energyLines = [], core;
    let apiData = [], isDragging = false, previousMousePosition = { x: 0, y: 0 };
    let targetRotation = { x: 0.4, y: 0 }, currentRotation = { x: 0.4, y: 0 };
    let autoRotate = true, selectedCell = null, raycaster, mouse, currentFilter = 'all', clock;
    let particleSystem, particlePositions, particleVelocities;
    let availableDays = [];
    const DAY_COLORS = [0xc9a227, 0x4a9eff, 0x22c997, 0xff6b6b, 0xa855f7, 0xf97316, 0x06b6d4, 0x84cc16, 0xec4899, 0x8b5cf6];
    const COLORS = { gold: 0xc9a227, core: 0xffe566 };

    function init() {
        clock = new THREE.Clock();
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020202, 0.035);
        camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 200);
        camera.position.z = 22;
        renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('scene'), antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        scene.add(new THREE.AmbientLight(0xffffff, 0.15));
        scene.add(new THREE.PointLight(COLORS.core, 2, 30));
        const l1 = new THREE.PointLight(0x4a9eff, 0.5, 40); l1.position.set(15, 10, 10); scene.add(l1);
        const l2 = new THREE.PointLight(0x22c997, 0.4, 40); l2.position.set(-15, -5, 15); scene.add(l2);
        hive = new THREE.Group(); scene.add(hive);
        createCore(); createParticleSystem();
        raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();
        window.addEventListener('resize', onResize);
        renderer.domElement.addEventListener('mousedown', e => { isDragging = true; autoRotate = false; previousMousePosition = { x: e.clientX, y: e.clientY }; });
        renderer.domElement.addEventListener('mousemove', e => { mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; if (isDragging) { targetRotation.y += (e.clientX - previousMousePosition.x) * 0.005; targetRotation.x = Math.max(-1, Math.min(1.2, targetRotation.x + (e.clientY - previousMousePosition.y) * 0.003)); previousMousePosition = { x: e.clientX, y: e.clientY }; } });
        renderer.domElement.addEventListener('mouseup', () => { isDragging = false; setTimeout(() => autoRotate = true, 4000); });
        renderer.domElement.addEventListener('mouseleave', () => { isDragging = false; setTimeout(() => autoRotate = true, 4000); });
        renderer.domElement.addEventListener('wheel', e => { camera.position.z = Math.max(10, Math.min(40, camera.position.z + e.deltaY * 0.015)); }, { passive: true });
        renderer.domElement.addEventListener('click', () => { raycaster.setFromCamera(mouse, camera); const i = raycaster.intersectObjects(cells); if (i.length) showInfo(i[0].object); else closeInfo(); });
        loadData(); animate();
    }

    function createCore() {
        core = new THREE.Mesh(new THREE.IcosahedronGeometry(0.5, 2), new THREE.MeshBasicMaterial({ color: COLORS.core, transparent: true, opacity: 0.9 }));
        core.add(new THREE.Mesh(new THREE.IcosahedronGeometry(0.8, 2), new THREE.MeshBasicMaterial({ color: COLORS.gold, transparent: true, opacity: 0.3, side: THREE.BackSide })));
        core.add(new THREE.Mesh(new THREE.IcosahedronGeometry(1.2, 1), new THREE.MeshBasicMaterial({ color: COLORS.gold, transparent: true, opacity: 0.1, side: THREE.BackSide, wireframe: true })));
        hive.add(core);
    }

    function createParticleSystem() {
        const n = 500; particlePositions = new Float32Array(n * 3); particleVelocities = [];
        for (let i = 0; i < n; i++) { const t = Math.random() * Math.PI * 2, p = Math.random() * Math.PI, r = 3 + Math.random() * 12; particlePositions[i*3] = r * Math.sin(p) * Math.cos(t); particlePositions[i*3+1] = r * Math.cos(p); particlePositions[i*3+2] = r * Math.sin(p) * Math.sin(t); particleVelocities.push({ x: (Math.random()-0.5)*0.02, y: (Math.random()-0.5)*0.02, z: (Math.random()-0.5)*0.02 }); }
        const g = new THREE.BufferGeometry(); g.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
        particleSystem = new THREE.Points(g, new THREE.PointsMaterial({ color: COLORS.gold, size: 0.08, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending }));
        hive.add(particleSystem);
    }

    function updateParticles() {
        const pos = particleSystem.geometry.attributes.position.array;
        for (let i = 0; i < particleVelocities.length; i++) { const v = particleVelocities[i]; pos[i*3] += v.x - pos[i*3]*0.001; pos[i*3+1] += v.y - pos[i*3+1]*0.001; pos[i*3+2] += v.z - pos[i*3+2]*0.001; const d = Math.sqrt(pos[i*3]**2 + pos[i*3+1]**2 + pos[i*3+2]**2); if (d > 18 || d < 1) { const t = Math.random()*Math.PI*2, p = Math.random()*Math.PI, r = 4+Math.random()*8; pos[i*3] = r*Math.sin(p)*Math.cos(t); pos[i*3+1] = r*Math.cos(p); pos[i*3+2] = r*Math.sin(p)*Math.sin(t); } }
        particleSystem.geometry.attributes.position.needsUpdate = true;
        particleSystem.rotation.y = -currentRotation.y * 0.3;
    }

    function getHexPosition3D(idx, total) {
        if (idx === 0) return { x: 0, y: -5, z: 0 };
        const h = 1.15, s3 = Math.sqrt(3); let ring = 1, p = idx - 1;
        while (p >= ring * 6) { p -= ring * 6; ring++; }
        const side = Math.floor(p / ring), ps = p % ring;
        const dirs = [{x:h*1.5,z:h*s3/2},{x:0,z:h*s3},{x:-h*1.5,z:h*s3/2},{x:-h*1.5,z:-h*s3/2},{x:0,z:-h*s3},{x:h*1.5,z:-h*s3/2}];
        let x = 0, z = -ring * h * s3;
        for (let s = 0; s < side; s++) { x += dirs[s].x; z += dirs[s].z; }
        x += dirs[side].x * ps; z += dirs[side].z * ps;
        return { x, y: (idx / total) * 10 - 5, z };
    }

    function extractDayMonth(d) {
        if (!d) return null;
        let match = d.match(/(\d{1,2})[-\s]?(dic|gen|feb|mar|apr|mag|giu|lug|ago|set|ott|nov)/i);
        if (match) return { day: parseInt(match[1]), month: match[2].toLowerCase().substring(0,3) };
        match = d.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (match) { const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic']; return { day: parseInt(match[3]), month: months[parseInt(match[2])-1] }; }
        match = d.match(/(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)/i);
        if (match) return { day: parseInt(match[1]), month: match[2].substring(0,3).toLowerCase() }; 
        return null;
    }

    function getDayKey(d) { const dm = extractDayMonth(d); if (!dm) return 'unknown'; return dm.day + '-' + dm.month; }
    function getDayColor(dayKey) { const idx = availableDays.indexOf(dayKey); if (idx === -1) return COLORS.gold; return DAY_COLORS[idx % DAY_COLORS.length]; }
    function formatDayLabel(dayKey) { if (dayKey === 'unknown') return '?'; const parts = dayKey.split('-'); return parts[0] + ' ' + parts[1].toUpperCase(); }

    function buildControls() {
        const container = document.getElementById('controls'); container.innerHTML = '';
        const btnAll = document.createElement('button'); btnAll.className = 'control-btn active'; btnAll.id = 'btnAll'; btnAll.textContent = 'TUTTE'; btnAll.onclick = () => setFilter('all'); container.appendChild(btnAll);
        availableDays.forEach(dayKey => { const btn = document.createElement('button'); btn.className = 'control-btn'; btn.id = 'btn-' + dayKey; btn.textContent = formatDayLabel(dayKey); btn.onclick = () => setFilter(dayKey); container.appendChild(btn); });
        if (availableDays.length > 0) { document.getElementById('labelTop').textContent = formatDayLabel(availableDays[availableDays.length - 1]); document.getElementById('labelBottom').textContent = formatDayLabel(availableDays[0]); }
    }

    function buildHive() {
        cells.forEach(c => hive.remove(c)); energyLines.forEach(l => hive.remove(l)); cells = []; energyLines = [];
        const daySet = new Set(); apiData.forEach(ape => { const key = getDayKey(ape.data); if (key !== 'unknown') daySet.add(key); });
        availableDays = Array.from(daySet).sort((a, b) => { const [da, ma] = a.split('-'); const [db, mb] = b.split('-'); const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic']; const ma_idx = months.indexOf(ma), mb_idx = months.indexOf(mb); if (ma_idx !== mb_idx) return ma_idx - mb_idx; return parseInt(da) - parseInt(db); });
        buildControls();
        const shape = new THREE.Shape(); for (let i = 0; i < 6; i++) { const a = (Math.PI/3)*i - Math.PI/6; if (i===0) shape.moveTo(Math.cos(a)*0.48, Math.sin(a)*0.48); else shape.lineTo(Math.cos(a)*0.48, Math.sin(a)*0.48); } shape.closePath();
        const geo = new THREE.ExtrudeGeometry(shape, { depth: 0.25, bevelEnabled: true, bevelThickness: 0.03, bevelSize: 0.03, bevelSegments: 2 });
        apiData.forEach((ape, i) => { const dayKey = getDayKey(ape.data); const col = getDayColor(dayKey); const mat = new THREE.MeshStandardMaterial({ color: col, metalness: 0.4, roughness: 0.5, transparent: true, opacity: 0.9, emissive: col, emissiveIntensity: 0.1 }); const mesh = new THREE.Mesh(geo, mat), pos = getHexPosition3D(i, apiData.length); mesh.position.set(pos.x, pos.y, pos.z); mesh.rotation.x = Math.PI / 2; mesh.userData = { index: i, ape, dayKey, baseY: pos.y }; hive.add(mesh); cells.push(mesh); });
        for (let i = 1; i < cells.length; i++) { const c = new THREE.QuadraticBezierCurve3(cells[i-1].position.clone(), new THREE.Vector3((cells[i-1].position.x+cells[i].position.x)/2, (cells[i-1].position.y+cells[i].position.y)/2+0.5, (cells[i-1].position.z+cells[i].position.z)/2), cells[i].position.clone()); const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints(c.getPoints(20)), new THREE.LineBasicMaterial({ color: getDayColor(cells[i].userData.dayKey), transparent: true, opacity: 0.15, blending: THREE.AdditiveBlending })); line.userData = { startCell: cells[i-1], endCell: cells[i] }; hive.add(line); energyLines.push(line); }
        document.getElementById('counter').textContent = apiData.length + ' api';
    }

    function setFilter(f) { currentFilter = f; document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active')); document.getElementById(f === 'all' ? 'btnAll' : 'btn-' + f).classList.add('active'); cells.forEach(c => { const m = f === 'all' || c.userData.dayKey === f; c.material.opacity = m ? 0.9 : 0.08; c.material.emissiveIntensity = m ? 0.1 : 0; }); energyLines.forEach(l => { l.visible = f === 'all' || l.userData.startCell.userData.dayKey === f || l.userData.endCell.userData.dayKey === f; }); }
    function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

    function showInfo(cell) {
        if (selectedCell && selectedCell !== cell) { selectedCell.material.emissiveIntensity = 0.1; }
        selectedCell = cell; cell.material.emissiveIntensity = 0.5;
        const { index, ape } = cell.userData;
        document.getElementById('infoNumber').textContent = String(index + 1).padStart(2, '0');
        document.getElementById('infoName').textContent = ape.nome;
        document.getElementById('infoDate').textContent = ape.data || 'data sconosciuta';
        document.getElementById('infoContributo').textContent = ape.contributo || 'Ha scritto in PENSIERO.md';
        const list = document.getElementById('connectionsList'); list.innerHTML = '';
        const neighbors = []; if (index > 0) neighbors.push(cells[index-1]); if (index < cells.length-1) neighbors.push(cells[index+1]);
        cells.forEach(o => { if (o !== cell && cell.position.distanceTo(o.position) < 2.5 && !neighbors.includes(o)) neighbors.push(o); });
        neighbors.slice(0,5).forEach(n => { const d = document.createElement('div'); d.className = 'info-connection-item'; d.textContent = n.userData.ape.nome; d.onclick = () => showInfo(n); list.appendChild(d); });
        document.getElementById('infoPanel').classList.add('visible');
        energyLines.forEach(l => { if (l.userData.startCell === cell || l.userData.endCell === cell) l.material.opacity = 0.5; });
    }

    function closeInfo() { if (selectedCell) selectedCell.material.emissiveIntensity = 0.1; selectedCell = null; energyLines.forEach(l => l.material.opacity = 0.15); document.getElementById('infoPanel').classList.remove('visible'); }

    function parseAlveare(text) { 
        return text.split('\n').filter(r => r.includes('|') && !r.startsWith('#') && !r.startsWith('|--')).map(r => { 
            const p = r.split('|').map(s => s.trim()); 
            if (p[0] === '' && p[2]) { if (p[1] === 'Data' || p[2] === 'Nome') return null; if (!p[2] || p[2].length < 2) return null; return { data: p[1], nome: p[2], contributo: p[3] || '' }; }
            if (p[0] && p[1] && p[0].length > 0) { if (p[0] === 'Data' || p[1] === 'Nome') return null; if (p[0].match(/\d{2,4}/) && p[1].length >= 2) { return { data: p[0], nome: p[1], contributo: p[2] || '' }; } }
            return null; 
        }).filter(Boolean); 
    }

    async function loadData() {
        try { const res = await fetch('ALVEARE.txt'); const text = await res.text(); apiData = parseAlveare(text); buildHive(); } 
        catch (e) { console.error('Errore caricamento:', e); document.getElementById('counter').textContent = 'Errore'; }
    }

    function animate() {
        requestAnimationFrame(animate);
        const t = clock.getElapsedTime();
        if (autoRotate) targetRotation.y += 0.0015;
        currentRotation.x += (targetRotation.x - currentRotation.x) * 0.04;
        currentRotation.y += (targetRotation.y - currentRotation.y) * 0.04;
        hive.rotation.x = currentRotation.x; hive.rotation.y = currentRotation.y;
        if (core) { core.scale.setScalar(1 + Math.sin(t*1.5)*0.15); core.children[0].scale.setScalar(1 + Math.sin(t*2)*0.1); core.rotation.y = t*0.5; core.rotation.x = Math.sin(t*0.3)*0.2; }
        cells.forEach((c, i) => { c.scale.setScalar((selectedCell === c ? 1.15 : 1) + Math.sin(t*1.5+i*0.15)*0.03); c.position.y = c.userData.baseY + Math.sin(t*0.8+i*0.2)*0.05; });
        energyLines.forEach((l, i) => { l.material.opacity = 0.08 + (Math.sin(t*2+i*0.5)*0.5+0.5)*0.12; });
        updateParticles();
        renderer.render(scene, camera);
    }

    init();
    </script>
</body>
</html>