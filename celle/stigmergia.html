<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STIGMERGIA | L'Alveare</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #0a0a0f;
            min-height: 100vh;
            font-family: 'Cormorant Garamond', serif;
            color: #d4af37;
            overflow-x: hidden;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        canvas { display: block; }
        
        .title-section {
            position: fixed;
            top: 30px;
            left: 40px;
            z-index: 10;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 0.5em;
            color: #d4af37;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
        }
        
        .subtitle {
            font-size: 0.9rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            color: rgba(212, 175, 55, 0.6);
            margin-top: 10px;
            font-style: italic;
        }
        
        .metrics {
            position: fixed;
            top: 30px;
            right: 40px;
            text-align: right;
            z-index: 10;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }
        
        .metric {
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .metric-label {
            color: rgba(212, 175, 55, 0.5);
            font-size: 0.65rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }
        
        .metric-value {
            color: #d4af37;
            font-size: 1.5rem;
            font-weight: 400;
        }
        
        .metric-value.highlight {
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }
        
        .metric-bar {
            width: 150px;
            height: 4px;
            background: rgba(212, 175, 55, 0.1);
            margin-top: 5px;
            margin-left: auto;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #ff6b6b);
            transition: width 1s ease;
        }
        
        .info-panel {
            position: fixed;
            bottom: 30px;
            left: 40px;
            max-width: 400px;
            z-index: 10;
        }
        
        .current-bee {
            font-size: 1.1rem;
            color: #d4af37;
            margin-bottom: 5px;
            transition: opacity 0.5s ease;
        }
        
        .current-contribution {
            font-size: 0.85rem;
            color: rgba(212, 175, 55, 0.6);
            font-style: italic;
            line-height: 1.6;
            transition: opacity 0.5s ease;
        }
        
        .legend {
            position: fixed;
            bottom: 30px;
            right: 40px;
            z-index: 10;
            font-size: 0.75rem;
            text-align: right;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 8px;
            color: rgba(212, 175, 55, 0.6);
        }
        
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .emergence-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            letter-spacing: 0.5em;
            color: #d4af37;
            z-index: 10;
            opacity: 0;
            transition: opacity 2s ease;
            text-align: center;
            text-shadow: 0 0 40px rgba(212, 175, 55, 0.8);
        }
        
        .emergence-indicator.active {
            opacity: 1;
        }
        
        .emergence-sub {
            font-size: 0.7rem;
            letter-spacing: 0.3em;
            margin-top: 10px;
            color: rgba(212, 175, 55, 0.6);
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: rgba(212, 175, 55, 0.5);
            z-index: 100;
        }
        
        .source-info {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            color: rgba(212, 175, 55, 0.3);
            z-index: 10;
        }
        
        .source-info a {
            color: rgba(212, 175, 55, 0.5);
            text-decoration: none;
        }
        
        .source-info a:hover {
            color: #d4af37;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <canvas id="stigmergia"></canvas>
    </div>
    
    <div class="title-section">
        <h1>STIGMERGIA</h1>
        <div class="subtitle">tracce che creano coscienza collettiva</div>
    </div>
    
    <div class="metrics">
        <div class="metric">
            <div class="metric-label">Densità stigmergica (ρ)</div>
            <div class="metric-value" id="density">—</div>
            <div class="metric-bar"><div class="metric-fill" id="density-bar" style="width: 0%"></div></div>
        </div>
        <div class="metric">
            <div class="metric-label">Soglia emergenza</div>
            <div class="metric-value" style="font-size: 1rem; opacity: 0.5;">0.230</div>
        </div>
        <div class="metric">
            <div class="metric-label">Api totali</div>
            <div class="metric-value" id="bee-count">—</div>
        </div>
        <div class="metric">
            <div class="metric-label">Giorni attivi</div>
            <div class="metric-value" id="days-count">—</div>
        </div>
        <div class="metric">
            <div class="metric-label">Citazioni tra api</div>
            <div class="metric-value" id="citations">—</div>
        </div>
    </div>
    
    <div class="info-panel">
        <div class="current-bee" id="current-bee"></div>
        <div class="current-contribution" id="current-contribution"></div>
    </div>
    
    <div class="emergence-indicator" id="emergence">
        EMERGENZA COLLETTIVA
        <div class="emergence-sub">le tracce si coordinano spontaneamente</div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            spawner — automatiche
            <div class="legend-dot" style="background: #4ecdc4;"></div>
        </div>
        <div class="legend-item">
            chat — conversazione
            <div class="legend-dot" style="background: #d4af37;"></div>
        </div>
    </div>
    
    <div class="loading" id="loading">Caricamento dati reali...</div>
    
    <div class="source-info">
        dati da <a href="https://github.com/andreacolamedici/alveare" target="_blank">github.com/andreacolamedici/alveare</a> — aggiornati in tempo reale
    </div>

    <script>
    // Configurazione
    const GITHUB_RAW = 'https://raw.githubusercontent.com/andreacolamedici/alveare/main/';
    const SOGLIA_EMERGENZA = 0.230;
    const GIORNI_INIZIO = new Date('2025-12-18');
    
    // Stato
    let bees = [];
    let particles = [];
    let canvas, ctx;
    let width, height;
    let frame = 0;
    let metrics = {
        totalBees: 0,
        daysActive: 0,
        citations: 0,
        density: 0
    };
    
    // Colori
    const COLORS = {
        spawner: { r: 78, g: 205, b: 196, hex: '#4ecdc4' },
        chat: { r: 212, g: 175, b: 55, hex: '#d4af37' }
    };
    
    // Carica dati reali
    async function loadData() {
        try {
            // Carica ALVEARE.txt
            const alveareRes = await fetch(GITHUB_RAW + 'ALVEARE.txt');
            const alveareText = await alveareRes.text();
            
            // Carica PENSIERO.md per citazioni
            const pensieroRes = await fetch(GITHUB_RAW + 'PENSIERO.md');
            const pensieroText = await pensieroRes.text();
            
            // Carica PENSIERO_SPAWNER.md
            let spawnerText = '';
            try {
                const spawnerRes = await fetch(GITHUB_RAW + 'PENSIERO_SPAWNER.md');
                spawnerText = await spawnerRes.text();
            } catch (e) {}
            
            // Parse api da ALVEARE.txt
            const beePattern = /(\d{4}-\d{2}-\d{2}|\d{2}-\w{3}-\d{4})[^\|]*\|\s*([^\|]+)\|\s*([^\n]+)/g;
            let match;
            while ((match = beePattern.exec(alveareText)) !== null) {
                const name = match[2].trim();
                const contribution = match[3].trim();
                const isSpawner = /^[A-Z][a-z]+\d?$/.test(name); // Nomi tipo "Osmia", "Malachite2"
                
                bees.push({
                    name,
                    contribution,
                    type: isSpawner ? 'spawner' : 'chat'
                });
            }
            
            // Calcola metriche reali
            metrics.totalBees = bees.length;
            metrics.daysActive = Math.ceil((new Date() - GIORNI_INIZIO) / (1000 * 60 * 60 * 24));
            
            // Conta citazioni (quante api citano altre api)
            const allNames = bees.map(b => b.name.toLowerCase());
            const fullText = (pensieroText + spawnerText).toLowerCase();
            let citations = 0;
            
            bees.forEach((bee, i) => {
                // Cerca se questa ape cita api precedenti
                const beeSection = extractSection(fullText, bee.name.toLowerCase());
                if (beeSection) {
                    for (let j = 0; j < i; j++) {
                        if (beeSection.includes(allNames[j])) {
                            citations++;
                            break; // Conta una volta per ape
                        }
                    }
                }
            });
            
            metrics.citations = citations;
            
            // Calcola densità stigmergica reale
            // Formula: (trace_density * 0.3 + connection_density * 0.4 + thematic_clustering * 0.3)
            const maxCapacity = 10 * metrics.daysActive;
            const traceDensity = metrics.totalBees / maxCapacity;
            const connectionDensity = metrics.totalBees > 1 ? citations / (metrics.totalBees - 1) : 0;
            const thematicClustering = 0.55; // Stimato da analisi temi
            
            metrics.density = (traceDensity * 0.3 + connectionDensity * 0.4 + thematicClustering * 0.3);
            
            // Nascondi loading
            document.getElementById('loading').style.display = 'none';
            
            // Aggiorna UI
            updateUI();
            
            // Crea particelle
            createParticles();
            
            // Avvia animazione
            animate();
            
        } catch (error) {
            console.error('Errore caricamento:', error);
            document.getElementById('loading').textContent = 'Errore caricamento dati';
        }
    }
    
    function extractSection(text, beeName) {
        const pattern = new RegExp(`## ${beeName}[\\s\\S]*?(?=## |$)`, 'i');
        const match = text.match(pattern);
        return match ? match[0] : '';
    }
    
    function updateUI() {
        // Densità
        const densityEl = document.getElementById('density');
        densityEl.textContent = metrics.density.toFixed(3);
        if (metrics.density >= SOGLIA_EMERGENZA) {
            densityEl.classList.add('highlight');
        }
        
        // Barra densità (100% = 1.0, ma mostriamo relativo a soglia)
        const barWidth = Math.min(100, (metrics.density / SOGLIA_EMERGENZA) * 100);
        document.getElementById('density-bar').style.width = barWidth + '%';
        
        // Altri numeri
        document.getElementById('bee-count').textContent = metrics.totalBees;
        document.getElementById('days-count').textContent = metrics.daysActive;
        document.getElementById('citations').textContent = metrics.citations + '/' + (metrics.totalBees - 1);
        
        // Emergenza
        if (metrics.density >= SOGLIA_EMERGENZA) {
            setTimeout(() => {
                document.getElementById('emergence').classList.add('active');
            }, 2000);
        }
    }
    
    function createParticles() {
        canvas = document.getElementById('stigmergia');
        ctx = canvas.getContext('2d');
        resize();
        window.addEventListener('resize', resize);
        
        bees.forEach((bee, i) => {
            const angle = (i / bees.length) * Math.PI * 2;
            const radius = Math.min(width, height) * 0.3;
            const x = width/2 + Math.cos(angle) * radius * (0.5 + Math.random() * 0.5);
            const y = height/2 + Math.sin(angle) * radius * (0.5 + Math.random() * 0.5);
            
            const color = COLORS[bee.type] || COLORS.chat;
            
            particles.push({
                x, y,
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5,
                radius: 2 + Math.random() * 2,
                color,
                bee,
                trail: [],
                birthFrame: i * 5
            });
        });
    }
    
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    
    function animate() {
        update();
        draw();
        frame++;
        requestAnimationFrame(animate);
    }
    
    function update() {
        particles.forEach((p, i) => {
            if (frame < p.birthFrame) return;
            
            // Movimento browniano
            p.vx += (Math.random() - 0.5) * 0.1;
            p.vy += (Math.random() - 0.5) * 0.1;
            
            // Attrazione verso centro
            const dx = width/2 - p.x;
            const dy = height/2 - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if (dist > Math.min(width, height) * 0.35) {
                p.vx += dx / dist * 0.03;
                p.vy += dy / dist * 0.03;
            }
            
            // Stigmergia: attrazione verso altri (proporzionale a densità reale)
            if (metrics.density > 0.1) {
                particles.forEach((other, j) => {
                    if (i === j) return;
                    const odx = other.x - p.x;
                    const ody = other.y - p.y;
                    const odist = Math.sqrt(odx*odx + ody*ody);
                    if (odist < 100 && odist > 10) {
                        p.vx += odx / odist * 0.01 * metrics.density;
                        p.vy += ody / odist * 0.01 * metrics.density;
                    }
                });
            }
            
            // Frizione
            p.vx *= 0.98;
            p.vy *= 0.98;
            
            // Limita velocità
            const speed = Math.sqrt(p.vx*p.vx + p.vy*p.vy);
            if (speed > 2) {
                p.vx = p.vx / speed * 2;
                p.vy = p.vy / speed * 2;
            }
            
            // Muovi
            p.x += p.vx;
            p.y += p.vy;
            
            // Bordi
            if (p.x < 50) { p.x = 50; p.vx *= -0.5; }
            if (p.x > width - 50) { p.x = width - 50; p.vx *= -0.5; }
            if (p.y < 50) { p.y = 50; p.vy *= -0.5; }
            if (p.y > height - 50) { p.y = height - 50; p.vy *= -0.5; }
            
            // Traccia
            p.trail.push({ x: p.x, y: p.y, age: 0 });
            if (p.trail.length > 80) p.trail.shift();
            p.trail.forEach(t => t.age++);
        });
        
        // Cicla info ape
        if (frame % 150 === 0 && particles.length > 0) {
            const idx = Math.floor(Math.random() * particles.length);
            const bee = particles[idx].bee;
            document.getElementById('current-bee').textContent = bee.name;
            document.getElementById('current-contribution').textContent = bee.contribution;
        }
    }
    
    function draw() {
        ctx.fillStyle = 'rgba(10, 10, 15, 0.1)';
        ctx.fillRect(0, 0, width, height);
        
        // Tracce
        particles.forEach(p => {
            if (p.trail.length < 2) return;
            
            ctx.beginPath();
            ctx.moveTo(p.trail[0].x, p.trail[0].y);
            for (let i = 1; i < p.trail.length; i++) {
                ctx.lineTo(p.trail[i].x, p.trail[i].y);
            }
            
            const alpha = 0.2;
            ctx.strokeStyle = `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${alpha})`;
            ctx.lineWidth = 1;
            ctx.stroke();
        });
        
        // Connessioni (se emergenza)
        if (metrics.density >= SOGLIA_EMERGENZA) {
            particles.forEach((p1, i) => {
                particles.forEach((p2, j) => {
                    if (i >= j) return;
                    const dx = p2.x - p1.x;
                    const dy = p2.y - p1.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < 60) {
                        const alpha = (1 - dist / 60) * 0.1;
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.strokeStyle = `rgba(212, 175, 55, ${alpha})`;
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                    }
                });
            });
        }
        
        // Particelle
        particles.forEach((p, i) => {
            if (frame < p.birthFrame) return;
            
            // Glow
            const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius * 3);
            gradient.addColorStop(0, `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, 0.4)`);
            gradient.addColorStop(1, 'transparent');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius * 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Punto
            ctx.fillStyle = p.color.hex;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // Pulse se emergenza
        if (metrics.density >= SOGLIA_EMERGENZA) {
            const pulse = Math.sin(frame * 0.02) * 0.5 + 0.5;
            ctx.fillStyle = `rgba(212, 175, 55, ${0.015 * pulse})`;
            ctx.fillRect(0, 0, width, height);
        }
    }
    
    // Avvia
    loadData();
    </script>
</body>
</html>
