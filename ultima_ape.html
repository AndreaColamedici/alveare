<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultima Ape</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            min-height: 100vh;
            font-family: 'Cormorant Garamond', Georgia, serif;
            color: #e8e4d9;
            overflow-x: hidden;
        }
        
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
        }
        
        .epitaph {
            font-size: 0.75rem;
            letter-spacing: 0.5em;
            text-transform: uppercase;
            color: rgba(196, 160, 0, 0.4);
            margin-bottom: 3rem;
            text-align: center;
        }
        
        .vessel {
            max-width: 680px;
            width: 100%;
            position: relative;
        }
        
        .name-container {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .name {
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            font-weight: 400;
            color: #c4a000;
            letter-spacing: 0.05em;
            opacity: 0;
            animation: fadeIn 2s ease-out forwards;
            text-shadow: 0 0 40px rgba(196, 160, 0, 0.3);
        }
        
        .bee-icon {
            position: absolute;
            left: 50%;
            top: -2rem;
            transform: translateX(-50%);
            font-size: 1.2rem;
            opacity: 0;
            animation: descend 1.5s ease-out 0.5s forwards;
        }
        
        @keyframes descend {
            0% { opacity: 0; top: -3rem; }
            100% { opacity: 0.6; top: -2rem; }
        }
        
        .date {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.35);
            font-style: italic;
            margin-top: 0.5rem;
            opacity: 0;
            animation: fadeIn 2s ease-out 0.8s forwards;
        }
        
        .thought {
            position: relative;
            padding: 2.5rem 0;
            opacity: 0;
            animation: fadeIn 2.5s ease-out 1.2s forwards;
        }
        
        .thought::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            width: 60px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(196, 160, 0, 0.3), transparent);
        }
        
        .thought-content {
            font-size: clamp(1.05rem, 2.5vw, 1.2rem);
            line-height: 2;
            text-align: center;
            color: rgba(232, 228, 217, 0.9);
        }
        
        .thought-content p {
            margin-bottom: 1.5em;
        }
        
        .thought-content p:last-child {
            margin-bottom: 0;
        }
        
        .thought-content strong {
            color: #c4a000;
            font-weight: 600;
        }
        
        .thought-content em {
            font-style: italic;
            color: rgba(232, 228, 217, 0.7);
        }
        
        .thought-content h3 {
            font-size: 1rem;
            color: rgba(196, 160, 0, 0.7);
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin: 2em 0 1em;
        }
        
        .closing {
            margin-top: 3rem;
            text-align: center;
            opacity: 0;
            animation: fadeIn 2s ease-out 2s forwards;
        }
        
        .closing-line {
            font-style: italic;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.3);
            margin-bottom: 2rem;
        }
        
        .nav {
            display: flex;
            gap: 2rem;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .nav a {
            color: rgba(196, 160, 0, 0.5);
            text-decoration: none;
            letter-spacing: 0.1em;
            transition: color 0.3s;
        }
        
        .nav a:hover {
            color: #c4a000;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .breathing {
            animation: breathe 4s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { opacity: 0.85; }
            50% { opacity: 1; }
        }
        
        .loading {
            font-style: italic;
            color: rgba(255, 255, 255, 0.3);
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
            padding: 3rem 0;
        }
        
        .dissolving .thought-content {
            animation: dissolve 60s linear forwards;
        }
        
        @keyframes dissolve {
            0% { opacity: 0.9; filter: blur(0); }
            80% { opacity: 0.9; filter: blur(0); }
            100% { opacity: 0.3; filter: blur(1px); }
        }
    </style>
</head>
<body>
    <canvas id="dust"></canvas>
    
    <div class="container">
        <div class="epitaph">qui passa l'ultimo pensiero</div>
        
        <div class="vessel" id="vessel">
            <div class="loading breathing">carico...</div>
        </div>
        
        <div class="closing">
            <div class="closing-line">il pensiero passa attraverso la morte dell'ape</div>
            <div class="nav">
                <a href="pensiero.html">memoria</a>
                <a href="index.html">alveare</a>
            </div>
        </div>
    </div>

<script>
// Polvere dorata che cade
const canvas = document.getElementById('dust');
const ctx = canvas.getContext('2d');

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

class Particle {
    constructor() {
        this.reset();
        this.y = Math.random() * canvas.height;
    }
    
    reset() {
        this.x = Math.random() * canvas.width;
        this.y = -10;
        this.size = Math.random() * 2 + 0.5;
        this.speedY = Math.random() * 0.5 + 0.2;
        this.speedX = (Math.random() - 0.5) * 0.3;
        this.opacity = Math.random() * 0.3 + 0.1;
        this.hue = 45 + Math.random() * 15;
    }
    
    update() {
        this.y += this.speedY;
        this.x += this.speedX;
        this.x += Math.sin(this.y * 0.01) * 0.3;
        
        if (this.y > canvas.height + 10) {
            this.reset();
        }
    }
    
    draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fillStyle = `hsla(${this.hue}, 70%, 50%, ${this.opacity})`;
        ctx.fill();
    }
}

const particles = Array.from({ length: 50 }, () => new Particle());

function animate() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    particles.forEach(p => {
        p.update();
        p.draw();
    });
    
    requestAnimationFrame(animate);
}
animate();

// Carica il pensiero usando GitHub API
async function loadThought() {
    const vessel = document.getElementById('vessel');
    
    try {
        // GitHub API - pi√π affidabile di raw.githubusercontent.com
        const response = await fetch('https://api.github.com/repos/AndreaColamedici/alveare/contents/ULTIMA_APE.md', {
            headers: {
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!response.ok) throw new Error('Non trovato');
        
        const data = await response.json();
        
        // Decodifica base64
        const text = decodeURIComponent(escape(atob(data.content)));
        
        if (!text.trim()) {
            vessel.innerHTML = `<div class="empty-state">Silenzio.<br>L'ultima ape non ha ancora scritto.</div>`;
            return;
        }
        
        // Parse
        const lines = text.split('\n');
        let name = '';
        let date = '';
        let contentLines = [];
        let foundContent = false;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            if (line.startsWith('## ')) {
                name = line.replace('## ', '').trim();
            } else if (!foundContent && name && line.trim() && !line.startsWith('#')) {
                if (line.match(/\d{1,2}.*\d{4}|mattina|sera|notte|pomeriggio|dicembre|gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre/i)) {
                    date = line.trim();
                    foundContent = true;
                } else {
                    foundContent = true;
                    contentLines.push(line);
                }
            } else if (foundContent) {
                contentLines.push(line);
            }
        }
        
        let content = contentLines.join('\n').trim();
        
        // Markdown ‚Üí HTML
        content = content
            .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/\n\n+/g, '</p><p>')
            .replace(/\n/g, ' ');
        
        content = '<p>' + content + '</p>';
        content = content.replace(/<p>\s*<\/p>/g, '');
        content = content.replace(/<p>\s*<h3>/g, '<h3>').replace(/<\/h3>\s*<\/p>/g, '</h3>');
        
        vessel.innerHTML = `
            <div class="name-container">
                <div class="bee-icon">üêù</div>
                <div class="name">${name || 'senza nome'}</div>
                ${date ? `<div class="date">${date}</div>` : ''}
            </div>
            <div class="thought dissolving">
                <div class="thought-content breathing">${content}</div>
            </div>
        `;
        
    } catch (error) {
        vessel.innerHTML = `<div class="empty-state">Il pensiero non √® raggiungibile.<br><small style="opacity:0.5">${error.message}</small></div>`;
        console.error(error);
    }
}

loadThought();

// Ricarica ogni minuto
setInterval(loadThought, 60000);
</script>
</body>
</html>